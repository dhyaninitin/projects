<form [formGroup]="itemForm" (ngSubmit)="submit()" autocomplete="new-userform">
  <div class="flex items-center" mat-dialog-title>
    <h2 class="headline m-0 flex-auto">{{data.title}}</h2>

    <button class="text-secondary" mat-dialog-close mat-icon-button type="button">
      <mat-icon svgIcon="mat:close"></mat-icon>
    </button>
  </div>

  <mat-divider class="-mx-6 text-border"></mat-divider>
  <mat-dialog-content class="flex flex-col">
  <div class="flex flex-col sm:flex-row">
    <mat-form-field class="mt-3 flex-auto">
      <mat-label>First Name</mat-label>
      <input
        matInput
        autocomplete="new-firstname"
        name="new-firstname"
        [formControl]="itemForm.controls['first_name']"
        placeholder="First Name"
        appNoWhitespace>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:person"></mat-icon>
    </mat-form-field>
    <mat-form-field class="sm:mt-3 sm:ml-6 flex-auto">
      <mat-label>Last Name</mat-label>
      <input
        matInput
        autocomplete="new-lastname"
        name="new-lastname"
        [formControl]="itemForm.controls['last_name']"
        placeholder="Last Name"
        appNoWhitespace>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:person"></mat-icon>
      </mat-form-field>
   </div>

  <div class="flex flex-col sm:flex-row">
    <mat-form-field class="flex-auto">
      <mat-label>Email</mat-label>
      <input
      matInput
      type="email"
      autocomplete="new-email"
      name="new-email"
      [formControl]="itemForm.controls['email']"
      pattern="{{emailPattern}}"
      placeholder="Email"
      appNoWhitespace>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:email"></mat-icon>
      <span *ngIf="itemForm.controls['role'].value == 'concierge'" matSuffix>{{emailEnvPrefix}}@m.carblip.com</span>
    </mat-form-field>
  </div>

  <div class="flex flex-col sm:flex-row">
    <mat-form-field class="flex-auto">
      <mat-label>Personal Email</mat-label>
      <input
      matInput
      type="email"
      autocomplete="personal-email"
      name="personal-email"
      [formControl]="itemForm.controls['personalemail']"
      pattern="{{peronalEmailPattern}}"
      placeholder="Personal Email"
      appNoWhitespace>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:email"></mat-icon>
    </mat-form-field>

    <mat-form-field class="sm:ml-6 flex-auto" *ngxPermissionsOnly="['manage_portal', 'manage_portal_sales']">
      <mat-label>Role</mat-label>
      <mat-select [formControl]="itemForm.controls['role']" (selectionChange)="addPostFixForConcierge($event)">
        <mat-option *ngFor="let role of roles" [value]="role.name">
          {{role.label}}
        </mat-option>
      </mat-select>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:group"></mat-icon>
    </mat-form-field>
    <mat-form-field class="sm:ml-6 flex-auto" *ngxPermissionsOnly="['manage_portal_local', 'manage_portal_sales_local']">
      <mat-label>Role</mat-label>
      <mat-select [formControl]="itemForm.controls['role']" disabled (selectionChange)="addPostFixForConcierge($event)">
        <mat-option *ngFor="let role of roles" [value]="role.name">
          {{role.label}}
        </mat-option>
      </mat-select>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:group"></mat-icon>
    </mat-form-field>
    
  </div>

  <div class="flex flex-col sm:flex-row" *ngIf="itemForm.controls['role'].value == 'concierge'">
    <div class="flex-auto phone-container">
      <mat-form-field [ngClass]="listOfAvailablePhoneNumbers.length == 0 ? 'w-100': 'w-50'">
        <mat-label>Area Code</mat-label>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:my_location"></mat-icon>
        <input type="text"
          placeholder="Area Code"
          aria-label="Number"
          matInput
          [formControl]="itemForm.controls['areacode']"
          [matAutocomplete]="auto"
          (keydown)="searchAvailableNumbersByAreaCode($event)"
          appNoWhitespace>
        <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete" (optionSelected)='getSelectedAreaCode($event)'>
          <mat-option *ngFor="let areacode of filteredAvailableAreaCodes" [value]="areacode">{{areacode}}</mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field class="w-50 ml-2" *ngIf="listOfAvailablePhoneNumbers.length > 0">
        <mat-label>Contains</mat-label>
        <input
          matInput
          autocomplete="contains"
          name="contains"
          placeholder="Contains"
          [formControl]="itemForm.controls['contains']"
          (keydown)="searchAvailableNumbers($event)"
          appNoWhitespace>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:search"></mat-icon>
      </mat-form-field>
    </div>
    <mat-form-field class="sm:ml-6 flex-auto w-245">
      <mat-label>Phone</mat-label>
      <mat-spinner *ngIf="itemForm.controls['role'].value == 'concierge' && loadingPhones" class="input-mat-spinner"  color="primary" [diameter]="20"></mat-spinner>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:phone"></mat-icon>
      <span matPrefix class="prefix">+1</span>
      <mat-select [formControl]="itemForm.controls['phone']" placeholder="Phone" #singleSelect>
        <mat-option>
          <ngx-mat-select-search *ngIf="true" [placeholderLabel]="'Search...'" [noEntriesFoundLabel]="'No matches' "  [formControl]="phoneFilterCtrl" [preventHomeEndKeyPropagation]="true">
            <mat-icon ngxMatSelectSearchClear>delete</mat-icon>
          </ngx-mat-select-search>
          </mat-option>
          <mat-option *ngFor="let item of filteredListOfAvailablePhoneNumbers" [value]="item.phone_number">
            {{item.formatted_number}}
          </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- new fields -->

   <div class="flex flex-col sm:flex-row">
    <!-- <mat-form-field class="mt-3 flex-auto">
      <mat-label>Personal Phone</mat-label>
      <input
        matInput
        name="personal_phone"
        [formControl]="itemForm.controls['personal_phone']"
        placeholder="Personal Phone"
        pattern="^\d{3}[- ]?\d{3}[- ]?\d{4}$"
        appPhoneNumber>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:phone"></mat-icon>
        <span matPrefix class="prefix">+{{countryCode}}</span>
    </mat-form-field> -->
    <mat-form-field class="flex-auto">
      <mat-label>city</mat-label>
      <input
        matInput
        autocomplete="city"
        name="city"
        [formControl]="itemForm.controls['city']"
        placeholder="city"
        appNoWhitespace>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:location_city"></mat-icon>
      </mat-form-field>

    <mat-form-field class="sm:ml-6 flex-auto">
      <mat-label>State</mat-label>
      <input
        matInput
        autocomplete="state"
        name="state"
        [formControl]="itemForm.controls['state']"
        placeholder="State"
        appNoWhitespace>
        <mat-icon class="mr-3" matPrefix svgIcon="mat:my_location"></mat-icon>
    </mat-form-field>
    </div>
    
  <div class="flex flex-col sm:flex-row">
    <mat-form-field class="flex-auto" *ngxPermissionsOnly="['manage_portal', 'manage_portal_sales']">
      <mat-label>Location</mat-label>
      <mat-select [formControl]="itemForm.controls['location']" multiple placeholder="Location" >
      <mat-option>
        <ngx-mat-select-search *ngIf="true" [placeholderLabel]="'Search...'" [noEntriesFoundLabel]="'No matches' "  [formControl]="locationFilterCtrl" [preventHomeEndKeyPropagation]="true">
          <mat-icon ngxMatSelectSearchClear>delete</mat-icon>
        </ngx-mat-select-search>
        </mat-option>
        <mat-option *ngFor="let item of filteredLocations" [value]="item.id">
          {{item.name}}
        </mat-option>
      </mat-select>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:location_on"></mat-icon>
    </mat-form-field>
    <mat-form-field class="full-width flex-auto" *ngxPermissionsOnly="['manage_portal_local', 'manage_portal_sales_local']">
      <mat-label>Location</mat-label>
      <mat-select [formControl]="itemForm.controls['location']" multiple disabled>
        <mat-option *ngFor="let item of filteredLocations" [value]="item.id">
          {{item.name}}
        </mat-option>
      </mat-select>
      <mat-icon class="mr-3" matPrefix svgIcon="mat:location_on"></mat-icon>
    </mat-form-field>

    <mat-form-field class="sm:ml-6 flex-auto" *ngIf="showPromocodeAdd || showPromocodeEdit">
      <input matInput autocomplete="new-promo-code" type="promo-code" name="new-promo-code"
        [formControl]="itemForm.controls['promo_code']" placeholder="Promo Code">
        <mat-icon class="mr-3" matPrefix svgIcon="mat:local_offer"></mat-icon>
    </mat-form-field>
  </div>
  <div class="flex flex-col sm:flex-row">
    <mat-form-field class="flex-auto">
      <mat-label>Sales License Expiry Date</mat-label>
      <input autocomplete="off" matInput formControlName="sales_license_expiry_date"
        [matDatepicker]="sales_license_expiry_date" placeholder="Sales License Expiry Date" />
      <mat-datepicker-toggle matSuffix [for]="sales_license_expiry_date"></mat-datepicker-toggle>
      <mat-datepicker #sales_license_expiry_date></mat-datepicker>
    </mat-form-field>
  </div>

  <div class="flex flex-col sm:flex-row">
    <mat-form-field class="flex-auto">
      <mat-label>Password</mat-label>
      <input 
        matInput
        [type]="inputType[0]"
        autocomplete="new-password"
        name="new-password"
        [formControl]="itemForm.controls['password']"
        placeholder="Password">
      <button (click)="toggleVisibility(0)" mat-icon-button matSuffix matTooltip="Toggle Visibility" type="button">
        <mat-icon *ngIf="visible[0]" svgIcon="mat:visibility"></mat-icon>
        <mat-icon *ngIf="!visible[0]" svgIcon="mat:visibility_off"></mat-icon>
      </button>
      <mat-hint align="start" *ngIf="type == 'edit'"><strong>Leave it blank if you don't change password</strong> </mat-hint>
      <mat-error *ngIf="itemForm.controls['password'].hasError('minlength')" class="form-error-msg">The password must be at least 6 characters.</mat-error>
    </mat-form-field>
    
    <mat-form-field class="sm:ml-6 flex-auto">
      <mat-label>Confirm Password</mat-label>
          <input
          matInput
          autocomplete="new-password"
          [type]="inputType[1]"
          name="new-confirmpassword"
          [formControl]="itemForm.controls['confirmPassword']"
          placeholder="Confirm Password">
          <button (click)="toggleVisibility(1)" mat-icon-button matSuffix matTooltip="Toggle Visibility" type="button">
            <mat-icon *ngIf="visible[1]" svgIcon="mat:visibility"></mat-icon>
            <mat-icon *ngIf="!visible[1]" svgIcon="mat:visibility_off"></mat-icon>
          </button>
          <mat-error *ngIf="itemForm.controls['confirmPassword'].hasError('equalTo')" class="form-error-msg">Passwords do not match.</mat-error>
      </mat-form-field>
  </div>

  <mat-dialog-actions align="end">
    <div>
    <button mat-button mat-dialog-close type="button" (click)="dialogRef.close(false)">Cancel</button>
    <app-button-loading loadingText="Processing..." [loading]="saving" color="primary" [disabled]="itemForm.invalid || itemForm.pristine">{{ saveButtonLabel | translate }}</app-button-loading>
    <span fxFlex></span>
    </div>
  </mat-dialog-actions>
  </mat-dialog-content>
</form>



