<!-- Add Task -->
<div class="px-gutter add-task-txt" @fadeInUp *ngIf="service$.isEnableAddNewTaskBtn">
	<div class="flex flex-col sm:grid-cols-4">
		<mat-form-field class="mt-3 flex-auto">
			<mat-label>Add New Task Title</mat-label>
			<input matInput type="text" placeholder="Write A New Task Title" (keyup.enter)="addTask($event)" (blur)="addTask($event)">
		</mat-form-field>
	</div>
</div>

<!--Expansion Table -->
<table mat-table *ngIf="tasks" @stagger
       [dataSource]="tasks" multiTemplateDataRows
       class="w-full" matSortActive={{sortKey}} matSortDirection={{sortDirection}} matSortDisableClear matSort (matSortChange)="sortData($event)" class="w-full">
  <ng-container matColumnDef="{{column.key}}" *ngFor="let column of columnHeaders">
    <th mat-header-cell *matHeaderCellDef> {{column.label}} </th>
    <!-- <td mat-cell *matCellDef="let element" [matTooltip]="createLogsMessage(element?.task_logs)" [ngClass]="element?.task_status == 1 ? 'disabled-row' : ''"> -->
		<td mat-cell *matCellDef="let element" [ngClass]="element?.task_status == 1 ? 'disabled-row' : ''">
		<span *ngIf="column?.key == 'title' || column?.key == 'description'" class="gap-2 flex">
			<mat-checkbox *ngIf="column?.key == 'title'" color="primary"  [matTooltip]="element?.task_status === 1 ? 'Mark As Incomplete' : 'Mark As Completed'"
			[checked]="element?.task_status === 1" (click)="$event.stopPropagation()" (change)="changeTaskStatus($event, element?.id)"></mat-checkbox>
			{{textTruncate(element[column.key])}}
		</span>  
		<span *ngIf="column?.key != 'title' && column?.key != 'description'">
			{{element[column.key]}}
		</span>
	</td>
  </ng-container>
  <ng-container matColumnDef="expand">
    <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
    <td mat-cell *matCellDef="let element" [ngClass]="element?.task_status == 1 ? 'disabled-row' : ''">
      <button mat-icon-button aria-label="expand row" (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation(); showTaskDetails(element, expandedElement = expandedElement === element ? null : element)">
        <mat-icon *ngIf="expandedElement !== element">keyboard_arrow_down</mat-icon>
        <mat-icon *ngIf="expandedElement === element">keyboard_arrow_up</mat-icon>
      </button>
    </td>
  </ng-container>

  <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
  <ng-container matColumnDef="expandedDetail">
    <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplayWithExpand.length">
      <div class="example-element-detail"
           [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
        <div>
          <!-- Expanded Body -->
		  	<div class="py-4 md:flex-row">
				<form [formGroup]="taskForm">
					<div class="flex flex-col sm:grid-cols-4">
						<mat-form-field class="mt-3 flex-auto">
							<mat-label>Title</mat-label>
							<input matInput type="text" [value]="element.title" formControlName="title" placeholder="Title">
						</mat-form-field>
					</div>

					<div class="flex flex-col sm:flex-row">
						<mat-form-field class="flex-auto">
							<mat-label>Due Date</mat-label>
							<input
							autocomplete="off"
							matInput
							formControlName="due_date"
							[matDatepicker]="due_date"
							placeholder="Due Date"
							[value]="element.due_date"
						/>
						<mat-datepicker-toggle
							matSuffix
							[for]="due_date"
						></mat-datepicker-toggle>
						<mat-datepicker #due_date></mat-datepicker>
						</mat-form-field>

						<mat-form-field class="sm:ml-6 flex-auto">
							<mat-label>Task Owner</mat-label>
							<mat-select formControlName="task_owner" 
							(infiniteScroll)="getNextBatchOfOwners()" [threshold]="'0.5%'" [debounceTime]="150" [complete]="ownerOffset === totalOwnersPages" msInfiniteScroll
							>
							<mat-option>
								<ngx-mat-select-search
									[placeholderLabel]="'Search...'"
									[noEntriesFoundLabel]="'No matches'"
									[formControl]="ownersFilterCtrl"
									[preventHomeEndKeyPropagation]="true">
								<mat-icon ngxMatSelectSearchClear
								>delete</mat-icon
								>
								</ngx-mat-select-search>
							</mat-option>
							<mat-option
								*ngFor="let item of filteredOwners"
								[value]="item.id"
							>
							{{ item.full_name }}
							</mat-option>
							<mat-option *ngIf="loadingOwners">
							<mat-spinner class="input-mat-spinner-loader"
							color="primary"
							[diameter]="30"></mat-spinner>
							</mat-option>
							</mat-select>
						</mat-form-field>
					</div>

					<div class="flex flex-col sm:grid-cols-4">
						<mat-form-field class="flex-auto">
							<mat-label>Description</mat-label>
							<textarea matInput placeholder="Description" [value]="element.description" formControlName="description" rows="2"></textarea>
						</mat-form-field>
					</div>

					<div class="flex justify-content-end" *ngIf="element?.task_status == 0"> 
						<button mat-button mat-raised-button type="button" color="primary" [disabled]="!taskForm.valid || taskForm.pristine" (click)="updateTask(element)">Update</button>
					</div>
				</form>
			</div>
			<h2 class="title m-0">History</h2><br>
			<div class="flex flex-col pl-2 mb-3 sm:flex-row">
				<ul class="log-ul">
					<li *ngFor="let log of sortFunc(element.task_logs)" @fadeInUp>
						<span [innerHTML]="log.content"></span>
						{{ formatLogMessage(log.content) }} {{ log.created_at | date:'MM/dd/yyy \'at\'
						hh:mm a'}}
					</li>
				</ul>
			</div>
        </div>
      </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
  <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;"
	  @fadeInUp
		class="hover:bg-hover trans-ease-out cursor-pointer example-element-row"
      [class.example-expanded-row]="expandedElement === element"
      (click)="showTaskDetails(element, expandedElement)">
  </tr>
  <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
</table>

<div class="text-center mt-2" *ngIf="(didFetch$ | async) && tasks.length === 0">There are no tasks available. Please enter in a tasks to view them here</div> 
